# 股票分析系统

## 触发条件

当用户提到以下关键词时，启动本工作流：
- 「分析 XXX 股票」「看看 XXX」「XXX 怎么样」
- 「刷新 XXX 数据」「更新 XXX」
- 「对比 A 和 B」「XXX vs YYY」
- 「宏观分析」「地缘风险」「避险配置」「当前周期」
- 「黄金怎么看」「美元走势」「秩序转换」

---

## 1. 执行流程

```
用户请求
    ↓
识别股票代码 → 转换为标准格式（见代码格式表）
    ↓
检查缓存 ./stock_cache/data/{symbol}.json
    ↓
┌─ 缓存存在且未过期 → 直接读取，输出分析
│
└─ 缓存不存在或已过期 → 获取新数据 → 写入缓存 → 输出分析
```

## 2. 缓存策略

### 2.1 有效期判断

```python
# 伪代码逻辑
def is_expired(updated_at, data_type):
    age = now() - updated_at
    limits = {
        "price": 24小时,      # 行情数据，每日更新
        "fundamentals": 7天,  # 财报数据，季度更新
        "news": 6小时,        # 新闻资讯，频繁更新
        "analyst": 3天        # 机构评级，定期更新
    }
    return age > limits[data_type]
```

### 2.2 缓存更新规则

| 场景 | 动作 |
|------|------|
| 无缓存 | 全量获取所有数据 |
| 价格过期 | 仅更新 price 字段 |
| 新闻过期 | 仅更新 news 字段 |
| 用户说「刷新」 | 强制全量更新 |

---

## 3. 数据结构

### 3.1 标准数据字段

```json
{
  "symbol": "002594.SZ",
  "name": "比亚迪",
  "market": "A股深市",
  "updated_at": "2025-12-07T14:00:00Z",

  "price": {
    "current": 95.98,
    "prev_close": 95.24,
    "change_pct": "+0.78%",
    "range_day": [94.71, 96.22],
    "range_52w": [87.40, 138.99],
    "volume": "35.92万手",
    "turnover": "34.84亿元"
  },

  "fundamentals": {
    "revenue_ytd": "5662.66亿元",
    "revenue_growth": "+12.75%",
    "net_profit_ytd": "233.33亿元",
    "profit_growth": "-7.55%",
    "gross_margin": "17.87%",
    "pe_ratio": null,
    "pb_ratio": null
  },

  "analyst": {
    "target_price_avg": 129.78,
    "target_price_high": 167,
    "target_price_low": 92,
    "buy_ratings": 28,
    "hold_ratings": 0,
    "sell_ratings": 2,
    "upside": "+35.22%"
  },

  "capital_flow": {
    "main_net": "+3.44亿元",
    "retail_net": "-2.31亿元",
    "north_net": null
  },

  "technical": {
    "ma5": null,
    "ma20": null,
    "support": null,
    "resistance": null,
    "signal": null
  },

  "news": []
}
```

### 3.2 股票代码格式

| 市场 | 格式 | 示例 | 识别规则 |
|------|------|------|----------|
| A股沪市 | {6位}.SS | 603993.SS | 60/68开头 |
| A股深市 | {6位}.SZ | 000001.SZ | 00/30/002开头 |
| 港股 | {4-5位}.HK | 1211.HK | 纯数字 |
| 美股 | {字母} | TSLA | 纯字母 |

---

## 4. 分析报告模板

输出报告应包含以下模块：

### 📊 股价概览
- 现价、涨跌幅、52周区间
- 当前位置（高位/中位/低位）

### 📈 基本面分析
- 营收、利润及增速
- 毛利率、PE、PB
- 同比环比变化

### 🎯 机构观点
- 目标价区间
- 买入/卖出评级数
- 潜在涨幅

### 💰 资金流向
- 主力/散户动向
- 北向资金（如有）

### ⚠️ 风险提示
- 技术面信号
- 需关注的风险点

---

## 5. 数据获取优先级

1. **WebSearch** - 快速获取最新行情和新闻
2. **WebFetch** - 抓取特定财经网站详情页
3. **Playwright** - 复杂页面爬取（需 browser 工具）

常用数据源：
- 东方财富：`quote.eastmoney.com`
- 雪球：`xueqiu.com`
- Yahoo Finance：`finance.yahoo.com`
- Investing.com：`investing.com`

---

## 6. 目录结构

```
./stock_cache/
├── cache_index.json          # 索引：记录每只股票的更新时间
├── data/
│   ├── {symbol}.json         # 单股数据文件
│   └── ...
└── reports/
    └── {symbol}_{date}.md    # 分析报告存档
```

---

## 7. 使用示例

| 用户说 | Claude 动作 |
|--------|-------------|
| 「分析比亚迪」 | 查缓存 → 有效则读取 → 输出分析 |
| 「刷新比亚迪数据」 | 强制获取最新数据 → 更新缓存 → 输出分析 |
| 「比亚迪 vs 特斯拉」 | 分别获取两只股票 → 对比分析 |
| 「最近分析过哪些股票」 | 读取 cache_index.json 列出 |
| 「宏观分析」 | 读取 macro_cache → 输出宏观环境评估 |
| 「地缘风险怎么样」 | 更新地缘风险数据 → 输出风险评估 |
| 「现在该怎么配置」 | 综合宏观数据 → 输出配置建议 |

---

## 8. 宏观分析模块（以史为鉴）

### 8.1 设计理念

```
分析层次：
第一层：日常行情（技术面、资金流）       ← 原有能力
第二层：基本面周期（财报、行业）         ← 原有能力
第三层：秩序周期（地缘、货币体系）       ← 新增模块
```

历史视角的价值：
- 识别**结构性相似**——信用体系动摇时资产如何重估
- 提供**锚定点**——知道"这不是第一次"能帮助保持理性
- 揭示**真正的风险变量**——不是日常波动，而是秩序级别的断裂

### 8.2 核心追踪模块

| 模块 | 文件 | 追踪内容 | 更新频率 |
|------|------|----------|----------|
| 地缘风险指数 | geopolitical_risk.json | 冲突烈度、制裁事件、紧张区域 | 12小时 |
| 货币信用指标 | monetary_credit.json | 美元指数、美债收益率、央行购金量 | 24小时 |
| 秩序转换信号 | order_transition.json | 去美元化进展、贸易脱钩、制度变化 | 7天 |
| 避险资产追踪 | safe_haven_assets.json | 黄金、美债、瑞郎、比特币 | 24小时 |

### 8.3 历史周期参考

参考文件：`./macro_cache/history/historical_cycles.json`

| 历史时期 | 核心特征 | 当代对照 |
|----------|----------|----------|
| 1870-1914 第一轮全球化 | 金本位、帝国竞争 | 大国竞争加剧 |
| 1945-1971 布雷顿森林 | 美元-黄金挂钩 | 美元信用承压 |
| 1980-2008 新自由主义 | 全球价值链 | 供应链重构 |
| 2022-? 当前转换期 | 多极化、地缘冲突 | 正在经历 |

元规律：
- **全球化周期**：建设-繁荣-危机-崩溃，典型持续40-70年
- **货币演化**：新锚建立→信用扩张→过度负债→信用危机→寻找新锚
- **霸权转移**：贸易摩擦→金融竞争→技术争夺→军备竞赛

### 8.4 宏观分析执行流程

```
用户请求宏观分析
    ↓
检查 macro_cache 各模块更新时间
    ↓
┌─ 未过期 → 直接读取
└─ 已过期 → WebSearch 获取最新数据 → 更新缓存
    ↓
综合各模块数据
    ↓
参考历史周期框架
    ↓
输出宏观环境评估 + 配置建议
```

### 8.5 宏观分析报告模板

#### 🌍 地缘政治环境
- 当前风险等级（1-10）
- 活跃冲突概况
- 潜在热点区域
- 制裁动态

#### 💵 货币信用状态
- 美元指数走势
- 美债收益率与曲线
- 央行购金动态
- 去美元化进展

#### 📊 周期定位
- 当前处于历史周期何阶段
- 与历史相似时期的对比
- 关键转折信号

#### 🛡️ 避险资产评估
- 黄金：价格、估值锚状态
- 美债：收益率、持有结构
- 其他避险工具

#### 💼 配置建议
根据情景给出资产配置框架：

| 情景 | 黄金 | 债券 | 股票 | 现金 |
|------|------|------|------|------|
| 低风险（平稳复苏） | 5-10% | 20-30% | 60-70% | - |
| 中风险（区域冲突） | 10-15% | 30-40% | 45-55% | - |
| 高风险（秩序断裂） | 20-30% | 30-40% | 30-40% | 10-20% |

### 8.6 数据获取优先级

1. **WebSearch** - 获取最新地缘事件、央行动态
2. **WebFetch** - 抓取专业数据源
   - 黄金：`gold.org`, `kitco.com`
   - 地缘：`cfr.org`, `crisisgroup.org`
   - 宏观：`imf.org`, `bis.org`

### 8.7 目录结构

```
./macro_cache/
├── macro_index.json              # 模块索引和更新时间
├── data/
│   ├── geopolitical_risk.json    # 地缘风险数据
│   ├── monetary_credit.json      # 货币信用数据
│   ├── order_transition.json     # 秩序转换信号
│   └── safe_haven_assets.json    # 避险资产数据
└── history/
    └── historical_cycles.json    # 历史周期参考框架
```

### 8.8 使用注意

**能做到的：**
- 识别结构性相似模式
- 提供历史参考框架
- 追踪关键宏观变量
- 给出情景化配置建议

**做不到的：**
- 预测具体时点和幅度
- 保证历史一定重演
- 替代专业投资顾问

> ⚠️ "历史不会简单重复，只是押韵。" —— 马克·吐温（存疑）
