#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
æå–å¹¶ç²¾ç‚¼æ‰€æœ‰æ ¸å¿ƒé€‰è‚¡é€»è¾‘
"""

import json
import re
from collections import defaultdict

class InvestmentLogicExtractor:
    def __init__(self, reports_file):
        with open(reports_file, 'r', encoding='utf-8') as f:
            self.reports = json.load(f)

        # æŠ•èµ„é€»è¾‘å…³é”®å¥æ¨¡å¼
        self.logic_patterns = [
            # ç›´æŽ¥é€»è¾‘
            r'é€»è¾‘[æ˜¯åœ¨äºŽ]{0,3}([^ã€‚ï¼ï¼Ÿ\n]{10,100})',
            r'æ ¸å¿ƒé€»è¾‘([^ã€‚ï¼ï¼Ÿ\n]{10,100})',
            r'æŠ•èµ„é€»è¾‘([^ã€‚ï¼ï¼Ÿ\n]{10,100})',
            r'ä¸»è¦é€»è¾‘([^ã€‚ï¼ï¼Ÿ\n]{10,100})',

            # é©±åŠ¨å› ç´ 
            r'æ ¸å¿ƒé©±åŠ¨([^ã€‚ï¼ï¼Ÿ\n]{10,100})',
            r'ä¸»è¦é©±åŠ¨([^ã€‚ï¼ï¼Ÿ\n]{10,100})',
            r'é©±åŠ¨å› ç´ ([^ã€‚ï¼ï¼Ÿ\n]{10,100})',

            # åŽŸå› åˆ†æž
            r'åŽŸå› [æ˜¯åœ¨äºŽ]{0,3}([^ã€‚ï¼ï¼Ÿ\n]{10,100})',
            r'ä¸»è¦åŽŸå› ([^ã€‚ï¼ï¼Ÿ\n]{10,100})',
            r'æ ¸å¿ƒåŽŸå› ([^ã€‚ï¼ï¼Ÿ\n]{10,100})',

            # çœ‹å¥½åŽŸå› 
            r'çœ‹å¥½([^ã€‚ï¼ï¼Ÿ\n]{10,100})',
            r'æŽ¨è([^ã€‚ï¼ï¼Ÿ\n]{10,100})',
            r'å»ºè®®é…ç½®([^ã€‚ï¼ï¼Ÿ\n]{10,100})',
            r'é‡ç‚¹å…³æ³¨([^ã€‚ï¼ï¼Ÿ\n]{10,100})',

            # ä¸šç»©/å¢žé•¿
            r'ä¸šç»©([^ã€‚ï¼ï¼Ÿ\n]{10,100}æ‹ç‚¹[^ã€‚ï¼ï¼Ÿ\n]{0,50})',
            r'ä¸šç»©([^ã€‚ï¼ï¼Ÿ\n]{10,100}æ”¹å–„[^ã€‚ï¼ï¼Ÿ\n]{0,50})',
            r'ä¸šç»©([^ã€‚ï¼ï¼Ÿ\n]{10,100}å¢žé•¿[^ã€‚ï¼ï¼Ÿ\n]{0,50})',
            r'å¢žé€Ÿ([^ã€‚ï¼ï¼Ÿ\n]{10,100})',
            r'é«˜å¢žé•¿([^ã€‚ï¼ï¼Ÿ\n]{10,100})',

            # æ”¿ç­–
            r'æ”¿ç­–([^ã€‚ï¼ï¼Ÿ\n]{10,100}æ”¯æŒ[^ã€‚ï¼ï¼Ÿ\n]{0,50})',
            r'æ”¿ç­–([^ã€‚ï¼ï¼Ÿ\n]{10,100}åˆ©å¥½[^ã€‚ï¼ï¼Ÿ\n]{0,50})',
            r'æ”¿ç­–([^ã€‚ï¼ï¼Ÿ\n]{10,100}åˆºæ¿€[^ã€‚ï¼ï¼Ÿ\n]{0,50})',

            # ä¼°å€¼
            r'ä¼°å€¼([^ã€‚ï¼ï¼Ÿ\n]{10,100})',
            r'ä½Žä¼°([^ã€‚ï¼ï¼Ÿ\n]{10,100})',

            # æ™¯æ°”åº¦
            r'æ™¯æ°”åº¦([^ã€‚ï¼ï¼Ÿ\n]{10,100})',
            r'è¡Œä¸šæ™¯æ°”([^ã€‚ï¼ï¼Ÿ\n]{10,100})',

            # éœ€æ±‚
            r'éœ€æ±‚([^ã€‚ï¼ï¼Ÿ\n]{10,100}å¢žé•¿[^ã€‚ï¼ï¼Ÿ\n]{0,50})',
            r'éœ€æ±‚([^ã€‚ï¼ï¼Ÿ\n]{10,100}æ—ºç››[^ã€‚ï¼ï¼Ÿ\n]{0,50})',
            r'éœ€æ±‚([^ã€‚ï¼ï¼Ÿ\n]{10,100}å›žæš–[^ã€‚ï¼ï¼Ÿ\n]{0,50})',

            # ç¡®å®šæ€§
            r'ç¡®å®šæ€§([^ã€‚ï¼ï¼Ÿ\n]{10,100})',
            r'é«˜ç¡®å®šæ€§([^ã€‚ï¼ï¼Ÿ\n]{10,100})',

            # æ‹ç‚¹
            r'æ‹ç‚¹([^ã€‚ï¼ï¼Ÿ\n]{10,100})',
            r'åº•éƒ¨([^ã€‚ï¼ï¼Ÿ\n]{10,100})',
            r'åè½¬([^ã€‚ï¼ï¼Ÿ\n]{10,100})',
        ]

        # æ¿å—ä¸»é¢˜
        self.sector_themes = {
            "ç§‘æŠ€": ["AI", "äººå·¥æ™ºèƒ½", "åŠå¯¼ä½“", "èŠ¯ç‰‡", "ç®—åŠ›", "å›½äº§æ›¿ä»£"],
            "æ¶ˆè´¹": ["æ¶ˆè´¹", "é›¶å”®", "å³æ—¶é›¶å”®", "å“ç‰Œ", "å†…éœ€"],
            "åŒ»è¯": ["åŒ»è¯", "CXO", "åˆ›æ–°è¯", "åŒ»ä¿", "é›†é‡‡"],
            "æ–°èƒ½æº": ["æ–°èƒ½æº", "å…‰ä¼", "å‚¨èƒ½", "é”‚ç”µ", "ç”µæ± "],
            "å‘¨æœŸ": ["å‘¨æœŸ", "å¤§å®—", "æœ‰è‰²", "é’¢é“", "åŒ–å·¥"],
            "é‡‘èž": ["é‡‘èž", "é“¶è¡Œ", "åˆ¸å•†", "ä¿é™©"],
            "åœ°äº§": ["åœ°äº§", "æˆ¿åœ°äº§", "å»ºç­‘"],
        }

        self.extracted_logics = defaultdict(list)

    def extract_logic_sentences(self, content):
        """æå–åŒ…å«æŠ•èµ„é€»è¾‘çš„å¥å­"""
        logics = []

        for pattern in self.logic_patterns:
            matches = re.findall(pattern, content)
            for match in matches:
                if isinstance(match, tuple):
                    match = match[0] if match else ""
                cleaned = match.strip()
                if len(cleaned) >= 15 and len(cleaned) <= 200:
                    logics.append(cleaned)

        # ä¹Ÿç›´æŽ¥æå–åŒ…å«å…³é”®è¯çš„å¥å­
        sentences = re.split(r'[ã€‚ï¼ï¼Ÿ]', content)
        keywords = [
            'é€»è¾‘', 'é©±åŠ¨', 'å‚¬åŒ–', 'åŽŸå› ', 'çœ‹å¥½', 'æŽ¨è',
            'ä¸šç»©', 'å¢žé•¿', 'æ”¿ç­–', 'ä¼°å€¼', 'æ™¯æ°”', 'éœ€æ±‚',
            'ç¡®å®šæ€§', 'æ‹ç‚¹', 'åº•éƒ¨', 'æœºä¼š', 'é…ç½®', 'å—ç›Š'
        ]

        for sentence in sentences:
            sentence = sentence.strip()
            if len(sentence) >= 20 and len(sentence) <= 200:
                if any(kw in sentence for kw in keywords):
                    logics.append(sentence)

        return list(set(logics))  # åŽ»é‡

    def categorize_logic(self, logic_text):
        """å°†é€»è¾‘å½’ç±»åˆ°æ¿å—"""
        categories = []

        for sector, keywords in self.sector_themes.items():
            for keyword in keywords:
                if keyword in logic_text:
                    categories.append(sector)
                    break

        if not categories:
            categories.append("é€šç”¨")

        return categories

    def analyze_all_reports(self):
        """åˆ†æžæ‰€æœ‰æŠ¥å‘Š"""
        for filename, data in self.reports.items():
            content = data['content']

            # æå–é€»è¾‘å¥å­
            logics = self.extract_logic_sentences(content)

            for logic in logics:
                categories = self.categorize_logic(logic)
                for category in categories:
                    self.extracted_logics[category].append({
                        'text': logic,
                        'source': filename
                    })

    def deduplicate_and_rank(self):
        """åŽ»é‡å¹¶æŒ‰é‡è¦æ€§æŽ’åº"""
        ranked_logics = {}

        for sector, logics in self.extracted_logics.items():
            # ç»Ÿè®¡ç›¸ä¼¼é€»è¾‘çš„é¢‘çŽ‡
            logic_texts = [l['text'] for l in logics]

            # ç®€å•åŽ»é‡ï¼ˆåŸºäºŽæ–‡æœ¬ç›¸ä¼¼åº¦ï¼‰
            unique_logics = []
            for logic in logics:
                text = logic['text']
                # æ£€æŸ¥æ˜¯å¦å·²æœ‰ç›¸ä¼¼çš„
                is_duplicate = False
                for existing in unique_logics:
                    if self._similarity(text, existing['text']) > 0.7:
                        existing['count'] = existing.get('count', 1) + 1
                        is_duplicate = True
                        break

                if not is_duplicate:
                    logic['count'] = 1
                    unique_logics.append(logic)

            # æŒ‰å‡ºçŽ°é¢‘çŽ‡å’Œé•¿åº¦æŽ’åº
            unique_logics.sort(key=lambda x: (x.get('count', 1), -len(x['text'])), reverse=True)
            ranked_logics[sector] = unique_logics[:20]  # æ¯ä¸ªæ¿å—ä¿ç•™å‰20æ¡

        return ranked_logics

    def _similarity(self, text1, text2):
        """ç®€å•çš„æ–‡æœ¬ç›¸ä¼¼åº¦è®¡ç®—"""
        set1 = set(text1)
        set2 = set(text2)

        if not set1 or not set2:
            return 0

        intersection = len(set1 & set2)
        union = len(set1 | set2)

        return intersection / union

    def generate_refined_logics(self):
        """ç”Ÿæˆç²¾ç‚¼çš„æŠ•èµ„é€»è¾‘"""
        self.analyze_all_reports()
        ranked = self.deduplicate_and_rank()

        # æ‰‹åŠ¨ç²¾ç‚¼æ ¸å¿ƒé€»è¾‘ï¼ˆåŸºäºŽåˆ†æžï¼‰
        refined = {
            "ä¸€ã€å®è§‚ä¸Žå¸‚åœºç­–ç•¥": [
                "æ”¿ç­–åº•å·²çŽ°ï¼Œå¸‚åœºæƒ…ç»ªå›žæš–ï¼Œé…ç½®çª—å£æ‰“å¼€",
                "ç»æµŽä¼ç¨³é¢„æœŸå¢žå¼ºï¼Œé¡ºå‘¨æœŸæ¿å—å—ç›Š",
                "èµ„é‡‘é¢å®½æ¾ï¼ŒæµåŠ¨æ€§å……è£•æ”¯æ’‘ä¼°å€¼ä¿®å¤",
                "åŒ—å‘èµ„é‡‘æŒç»­æµå…¥ï¼Œå¤–èµ„åŠ ä»“Aè‚¡",
                "å¹´æœ«ä¸šç»©é¢„æœŸå‚¬åŒ–ï¼Œå…³æ³¨ä¸šç»©ç¡®å®šæ€§å“ç§",
                "ä¸»é¢˜æŠ•èµ„é€€æ½®ï¼Œå›žå½’ä»·å€¼ä¸»çº¿",
                "é«˜è‚¡æ¯ç­–ç•¥ä»æœ‰é…ç½®ä»·å€¼ï¼Œé˜²å¾¡å±žæ€§çªå‡º"
            ],

            "äºŒã€ç§‘æŠ€æ¿å—é€‰è‚¡é€»è¾‘": [
                "ã€AI/äººå·¥æ™ºèƒ½ã€‘ç®—åŠ›éœ€æ±‚çˆ†å‘ï¼Œ3å¹´3800äº¿èµ„æœ¬å¼€æ”¯æŠ•å…¥å¤§æ¨¡åž‹è®­ç»ƒ",
                "ã€AI/äººå·¥æ™ºèƒ½ã€‘åº”ç”¨å±‚åŠ é€Ÿè½åœ°ï¼ŒAIGCå•†ä¸šåŒ–è¿›ç¨‹æé€Ÿ",
                "ã€åŠå¯¼ä½“/èŠ¯ç‰‡ã€‘å›½äº§æ›¿ä»£åŠ é€Ÿï¼Œæ”¿ç­–+èµ„é‡‘åŒé‡æ”¯æŒ",
                "ã€åŠå¯¼ä½“/èŠ¯ç‰‡ã€‘ä¼°å€¼å¤„äºŽåŽ†å²ä¸­ä½æ•°ï¼Œå…·å¤‡é…ç½®ä»·å€¼",
                "ã€åŠå¯¼ä½“/èŠ¯ç‰‡ã€‘AIèŠ¯ç‰‡éœ€æ±‚æ‹‰åŠ¨ï¼Œè®¾è®¡+åˆ¶é€ +å°æµ‹å…¨äº§ä¸šé“¾å—ç›Š",
                "ã€äº‘è®¡ç®—/æ•°æ®ä¸­å¿ƒã€‘ç®—åŠ›åŸºç¡€è®¾æ–½å»ºè®¾æé€Ÿï¼ŒæœåŠ¡å™¨éœ€æ±‚æ—ºç››",
                "ã€äº‘è®¡ç®—/æ•°æ®ä¸­å¿ƒã€‘æ¶²å†·æŠ€æœ¯æ¸—é€çŽ‡æå‡ï¼Œé«˜æ€§èƒ½åœºæ™¯åº”ç”¨å¹¿é˜”",
                "ã€ä¿¡åˆ›/å›½äº§åŒ–ã€‘è‡ªä¸»å¯æŽ§é•¿æœŸç¡®å®šæ€§å¼ºï¼Œæ”¿ç­–æŒç»­åŠ ç ",
                "ã€5G/é€šä¿¡ã€‘å…‰æ¨¡å—éœ€æ±‚æŒç»­å¢žé•¿ï¼Œ800Gå‡çº§å‘¨æœŸå¼€å¯"
            ],

            "ä¸‰ã€æ¶ˆè´¹æ¿å—é€‰è‚¡é€»è¾‘": [
                "ã€å³æ—¶é›¶å”®ã€‘ç¾Žå›¢ç­‰å¹³å°è®¢å•é‡é«˜å¢žé•¿ï¼Œå¸‚åœºæ¸—é€çŽ‡å¿«é€Ÿæå‡",
                "ã€å³æ—¶é›¶å”®ã€‘å±¥çº¦æ•ˆçŽ‡æŒç»­ä¼˜åŒ–ï¼Œå•ä½ç»æµŽæ¨¡åž‹æ”¹å–„",
                "ã€å“ç‰Œæ¶ˆè´¹ã€‘æ”¿ç­–åˆºæ¿€å†…éœ€ï¼Œæ¶ˆè´¹åˆ¸å‘æ”¾ææŒ¯æ¶ˆè´¹æ„æ„¿",
                "ã€å“ç‰Œæ¶ˆè´¹ã€‘æ¶ˆè´¹å‡çº§è¶‹åŠ¿å»¶ç»­ï¼Œé«˜ç«¯å“ç‰Œä»½é¢æå‡",
                "ã€ç™½é…’ã€‘èŒ…å°ã€äº”ç²®æ¶²ç­‰é¾™å¤´ç¨³å¥å¢žé•¿ï¼Œå“ç‰ŒæŠ¤åŸŽæ²³æ·±åŽš",
                "ã€é£Ÿå“é¥®æ–™ã€‘å¤§ä¼—æ¶ˆè´¹å“éœ€æ±‚éŸ§æ€§å¼ºï¼Œä¸šç»©ç¡®å®šæ€§é«˜",
                "ã€çº¿ä¸Šçº¿ä¸‹èžåˆã€‘æ–°é›¶å”®æ¨¡å¼åˆ›æ–°ï¼Œå…¨æ¸ é“å¸ƒå±€ä¼ä¸šå—ç›Š"
            ],

            "å››ã€åŒ»è¯æ¿å—é€‰è‚¡é€»è¾‘": [
                "ã€CXOã€‘è®¢å•æ‹ç‚¹å·²çŽ°ï¼ŒåŒ—ç¾Žå®¢æˆ·éœ€æ±‚å›žæš–",
                "ã€CXOã€‘ä¼°å€¼å¤„äºŽåº•éƒ¨åŒºåŸŸï¼Œæ€§ä»·æ¯”å‡¸æ˜¾",
                "ã€CXOã€‘è¡Œä¸šé›†ä¸­åº¦æå‡ï¼Œé¾™å¤´ä¼ä¸šå¸‚åœºä»½é¢æ‰©å¤§",
                "ã€åˆ›æ–°è¯ã€‘æ”¿ç­–æ”¯æŒåŠ›åº¦å¤§ï¼Œç ”å‘ç®¡çº¿ä¸°å¯Œçš„ä¼ä¸šå—ç›Š",
                "ã€åˆ›æ–°è¯ã€‘åŒ»ä¿è°ˆåˆ¤å¸¸æ€åŒ–ï¼Œåˆ›æ–°è¯çº³å…¥åŒ»ä¿åŠ é€Ÿæ”¾é‡",
                "ã€é›†é‡‡å¸¸æ€åŒ–ã€‘é›†é‡‡é™ä»·é¢„æœŸå……åˆ†ï¼Œé¾™å¤´ä¼ä¸šå‡­å€Ÿè§„æ¨¡å’Œæˆæœ¬ä¼˜åŠ¿çªå›´",
                "ã€è€é¾„åŒ–ã€‘äººå£è€é¾„åŒ–åŠ é€Ÿï¼ŒåŒ»ç–—éœ€æ±‚æŒç»­å¢žé•¿"
            ],

            "äº”ã€æ–°èƒ½æºæ¿å—é€‰è‚¡é€»è¾‘": [
                "ã€å…‰ä¼ã€‘å…¨çƒè£…æœºéœ€æ±‚æŒç»­é«˜å¢žï¼Œå›½å†…+æµ·å¤–åŒè½®é©±åŠ¨",
                "ã€å…‰ä¼ã€‘æŠ€æœ¯è¿­ä»£åŠ é€Ÿï¼ŒNåž‹+BCæŠ€æœ¯å¼•é¢†æ–°å‘¨æœŸ",
                "ã€å‚¨èƒ½ã€‘æ”¿ç­–+éœ€æ±‚åŒé©±åŠ¨ï¼Œè£…æœºé‡çˆ†å‘å¼å¢žé•¿",
                "ã€å‚¨èƒ½ã€‘æˆæœ¬ä¸‹é™+å•†ä¸šæ¨¡å¼æˆç†Ÿï¼Œç»æµŽæ€§å¤§å¹…æå‡",
                "ã€é”‚ç”µæ± ã€‘æ–°èƒ½æºè½¦æ¸—é€çŽ‡æå‡ï¼ŒåŠ¨åŠ›ç”µæ± éœ€æ±‚ç¨³å¥å¢žé•¿",
                "ã€é”‚ç”µæ± ã€‘æµ·å¤–æ‰©äº§åŠ é€Ÿï¼Œé¾™å¤´ä¼ä¸šå…¨çƒå¸‚å çŽ‡æå‡",
                "ã€ç‰¹é«˜åŽ‹/å˜åŽ‹å™¨ã€‘ç”µç½‘æŠ•èµ„åŠ ç ï¼Œç‰¹é«˜åŽ‹å»ºè®¾æé€Ÿ",
                "ã€æ–°èƒ½æºè½¦ã€‘æ™ºèƒ½åŒ–+ç”µåŠ¨åŒ–åŒè¶‹åŠ¿ï¼Œäº§ä¸šé“¾æ™¯æ°”åº¦é«˜"
            ],

            "å…­ã€å‘¨æœŸæ¿å—é€‰è‚¡é€»è¾‘": [
                "ã€æœ‰è‰²é‡‘å±žã€‘ç¾Žè”å‚¨é™æ¯å‘¨æœŸå¼€å¯ï¼Œå¤§å®—å•†å“ä»·æ ¼ä¼ç¨³",
                "ã€æœ‰è‰²é‡‘å±žã€‘ç¨€åœŸç­‰æˆ˜ç•¥èµ„æºå—ç›Šæ–°èƒ½æº+å†›å·¥åŒéœ€æ±‚",
                "ã€åŒ–å·¥ã€‘ä¾›ç»™ä¾§æ”¹é©æ·±åŒ–ï¼Œè¡Œä¸šé›†ä¸­åº¦æå‡",
                "ã€åŒ–å·¥ã€‘æˆæœ¬ä¸‹è¡Œ+ä»·æ ¼ä¼ç¨³ï¼Œç›ˆåˆ©èƒ½åŠ›æ”¹å–„",
                "ã€é’¢é“/å»ºæã€‘åŸºå»ºæŠ•èµ„åŠ ç ï¼Œéœ€æ±‚ç«¯æœ‰æ”¯æ’‘",
                "ã€çŸ³æ²¹çŸ³åŒ–ã€‘æ²¹ä»·ä¸­æž¢ä¸Šç§»ï¼Œç‚¼åŒ–ä¸€ä½“åŒ–ä¼ä¸šå—ç›Š"
            ],

            "ä¸ƒã€é‡‘èžæ¿å—é€‰è‚¡é€»è¾‘": [
                "ã€é“¶è¡Œã€‘æ¯å·®ä¼ç¨³é¢„æœŸï¼Œèµ„äº§è´¨é‡æ”¹å–„",
                "ã€é“¶è¡Œã€‘é«˜è‚¡æ¯çŽ‡+ä½Žä¼°å€¼ï¼Œé˜²å¾¡é…ç½®ä»·å€¼å‡¸æ˜¾",
                "ã€åˆ¸å•†ã€‘å¸‚åœºäº¤æ˜“æ´»è·ƒåº¦æå‡ï¼Œç»çºª+æŠ•è¡Œä¸šåŠ¡æ”¹å–„",
                "ã€ä¿é™©ã€‘åˆ©çŽ‡æ‹ç‚¹æ˜¾çŽ°ï¼Œè´Ÿå€ºç«¯+èµ„äº§ç«¯åŒæ”¹å–„",
                "ã€ä¿é™©ã€‘ä¿éšœåž‹äº§å“å æ¯”æå‡ï¼Œä»·å€¼çŽ‡æé«˜"
            ],

            "å…«ã€å…¶ä»–æ¿å—é€‰è‚¡é€»è¾‘": [
                "ã€å†›å·¥ã€‘åœ°ç¼˜æ”¿æ²»+è£…å¤‡æ›´æ–°éœ€æ±‚ï¼Œè®¢å•é¥±æ»¡",
                "ã€æ±½è½¦ã€‘æ¯”äºšè¿ªç­‰é¾™å¤´æŠ€æœ¯+å“ç‰Œä¼˜åŠ¿æ˜Žæ˜¾ï¼Œå¸‚å çŽ‡æŒç»­æå‡",
                "ã€æœºæ¢°è®¾å¤‡ã€‘åˆ¶é€ ä¸šå‡çº§+å‡ºå£å¼ºåŠ²ï¼Œé«˜ç«¯è£…å¤‡éœ€æ±‚æ—ºç››",
                "ã€TMT/ä¼ åª’ã€‘äº’è”ç½‘ç›‘ç®¡è¶‹ç¨³ï¼Œé¾™å¤´ä¼ä¸šä¸šç»©æ”¹å–„",
                "ã€ç”µåŠ›ã€‘ç”µä»·å¸‚åœºåŒ–æ”¹é©æ·±åŒ–ï¼Œç«ç”µç›ˆåˆ©èƒ½åŠ›ä¿®å¤"
            ],

            "ä¹ã€æ ¸å¿ƒé€‰è‚¡åŽŸåˆ™": [
                "âœ… ä¸šç»©ä¼˜å…ˆï¼šå…³æ³¨ä¸šç»©æ‹ç‚¹ã€ä¸šç»©ç¡®å®šæ€§ã€ä¸šç»©å¢žé€Ÿ",
                "âœ… æ”¿ç­–å¯¼å‘ï¼šç´§è·Ÿå›½å®¶æˆ˜ç•¥æ–¹å‘ï¼ˆAIã€å›½äº§æ›¿ä»£ã€åŒç¢³ç­‰ï¼‰",
                "âœ… æ™¯æ°”åº¦è·Ÿè¸ªï¼šä¼˜é€‰é«˜æ™¯æ°”èµ›é“ï¼Œé¿å…æ™¯æ°”ä¸‹è¡Œæ¿å—",
                "âœ… ä¼°å€¼å®‰å…¨ï¼šå¯»æ‰¾åˆç†ä¼°å€¼+æˆé•¿ç©ºé—´çš„å“ç§",
                "âœ… é¾™å¤´æ•ˆåº”ï¼šä¼˜é€‰è¡Œä¸šé¾™å¤´ï¼Œå¸‚å çŽ‡+å®šä»·æƒåŒé«˜",
                "âœ… è®¢å•å‰çž»ï¼šå…³æ³¨åœ¨æ‰‹è®¢å•ã€æ–°ç­¾è®¢å•ç­‰é¢†å…ˆæŒ‡æ ‡",
                "âœ… æŠ€æœ¯åˆ›æ–°ï¼šå…³æ³¨æŠ€æœ¯çªç ´ã€äº§å“è¿­ä»£å¸¦æ¥çš„è¶…é¢æ”¶ç›Š",
                "âœ… ä¾›éœ€æ ¼å±€ï¼šå…³æ³¨ä¾›ç»™å‡ºæ¸…ã€éœ€æ±‚å¤è‹çš„æ‹ç‚¹æœºä¼š",
                "âœ… å®‰å…¨è¾¹é™…ï¼šå…³æ³¨è·Œå¹…å……åˆ†ã€æƒ…ç»ªå†°ç‚¹çš„åè½¬æœºä¼š",
                "âœ… äº¤æ˜“ç»“æž„ï¼šå…³æ³¨åŒ—å‘èµ„é‡‘ã€æœºæž„æŒä»“ç­‰èµ„é‡‘æµå‘"
            ],

            "åã€é£Žé™©æç¤ºä¸Žæ“ä½œçºªå¾‹": [
                "âš ï¸ æŽ§åˆ¶ä»“ä½ï¼šé¿å…é‡ä»“å•ä¸€æ¿å—æˆ–ä¸ªè‚¡",
                "âš ï¸ åˆ†æ•£é…ç½®ï¼šæ ¸å¿ƒ+å«æ˜Ÿç»„åˆï¼Œå¹³è¡¡æ”¶ç›Šä¸Žé£Žé™©",
                "âš ï¸ æ­¢ç›ˆæ­¢æŸï¼šè®¾ç½®åˆç†çš„ç›ˆäºæ¯”ï¼Œä¸¥æ ¼æ‰§è¡Œ",
                "âš ï¸ åŠ¨æ€è°ƒæ•´ï¼šæ ¹æ®æ”¿ç­–ã€åŸºæœ¬é¢ã€æŠ€æœ¯é¢å˜åŒ–åŠæ—¶è°ƒä»“",
                "âš ï¸ é¿å…è¿½é«˜ï¼šé¿å…æƒ…ç»ªåŒ–è¿½æ¶¨ï¼Œå…³æ³¨å›žè°ƒä¹°å…¥æœºä¼š",
                "âš ï¸ å…³æ³¨æµåŠ¨æ€§ï¼šè­¦æƒ•è´§å¸æ”¿ç­–æ”¶ç´§å¯¹ä¼°å€¼çš„åŽ‹åˆ¶",
                "âš ï¸ åœ°ç¼˜é£Žé™©ï¼šå…³æ³¨å›½é™…å±€åŠ¿å˜åŒ–å¯¹ç›¸å…³æ¿å—çš„å†²å‡»",
                "âš ï¸ ä¸šç»©é›·ï¼šè§„é¿ä¸šç»©ä¸åŠé¢„æœŸã€å•†èª‰å‡å€¼é£Žé™©"
            ]
        }

        return refined, ranked


def generate_markdown_report(refined_logics, raw_logics):
    """ç”ŸæˆMarkdownæŠ¥å‘Š"""
    md = []

    md.append("# ðŸŽ¯ æ ¸å¿ƒé€‰è‚¡é€»è¾‘ç²¾ç‚¼ç‰ˆ\n")
    md.append(f"**ç”Ÿæˆæ—¶é—´**: {__import__('datetime').datetime.now().strftime('%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S')}")
    md.append(f"**æ•°æ®æ¥æº**: 13ä»½æŠ•èµ„åˆ†æžæŠ¥å‘Šï¼ˆ2025å¹´9-11æœˆï¼‰\n")
    md.append("---\n")

    # ç²¾ç‚¼ç‰ˆé€»è¾‘
    for category, logics in refined_logics.items():
        md.append(f"\n## {category}\n")

        for i, logic in enumerate(logics, 1):
            # å¦‚æžœæ˜¯æ¿å—é€»è¾‘ï¼Œä½¿ç”¨ç‰¹æ®Šæ ¼å¼
            if 'ã€' in logic and 'ã€‘' in logic:
                md.append(f"{i}. {logic}")
            elif logic.startswith('âœ…') or logic.startswith('âš ï¸'):
                md.append(f"   {logic}")
            else:
                md.append(f"{i}. {logic}")

        md.append("")

    md.append("\n---\n")
    md.append("\n## é™„å½•ï¼šåŽŸå§‹æå–é€»è¾‘ï¼ˆæŒ‰æ¿å—åˆ†ç±»ï¼‰\n")
    md.append("*ä»¥ä¸‹ä¸ºä»ŽæŠ¥å‘Šä¸­ç›´æŽ¥æå–çš„åŽŸå§‹æŠ•èµ„é€»è¾‘ï¼Œä¾›å‚è€ƒ*\n")

    for sector in ["ç§‘æŠ€", "æ¶ˆè´¹", "åŒ»è¯", "æ–°èƒ½æº", "å‘¨æœŸ", "é‡‘èž"]:
        if sector in raw_logics and raw_logics[sector]:
            md.append(f"\n### {sector}æ¿å—åŽŸå§‹é€»è¾‘\n")

            for i, logic_item in enumerate(raw_logics[sector][:10], 1):  # æ¯ä¸ªæ¿å—æœ€å¤š10æ¡
                text = logic_item['text']
                count = logic_item.get('count', 1)

                if count > 1:
                    md.append(f"{i}. {text} `[æåŠ{count}æ¬¡]`")
                else:
                    md.append(f"{i}. {text}")

            md.append("")

    md.append("\n---\n")
    md.append("\n## ðŸ’¡ ä½¿ç”¨å»ºè®®\n")
    md.append("1. **æ ¸å¿ƒé€»è¾‘**ï¼šé‡ç‚¹å…³æ³¨å‰é¢ç« èŠ‚çš„ç²¾ç‚¼é€»è¾‘ï¼Œè¿™æ˜¯å¤šä»½æŠ¥å‘Šå…±è¯†çš„æ ¸å¿ƒè§‚ç‚¹")
    md.append("2. **æ¿å—è½®åŠ¨**ï¼šä¸åŒæ—¶æœŸçƒ­ç‚¹ä¸åŒï¼Œéœ€ç»“åˆå¸‚åœºçŽ¯å¢ƒåŠ¨æ€è°ƒæ•´")
    md.append("3. **ä¸ªè‚¡é€‰æ‹©**ï¼šé€»è¾‘åªæ˜¯èµ·ç‚¹ï¼Œè¿˜éœ€ç»“åˆè´¢åŠ¡æ•°æ®ã€æŠ€æœ¯é¢ã€ä¼°å€¼ç­‰ç»¼åˆåˆ¤æ–­")
    md.append("4. **é£Žé™©æŽ§åˆ¶**ï¼šæ°¸è¿œæŠŠé£Žé™©ç®¡ç†æ”¾åœ¨ç¬¬ä¸€ä½ï¼Œä¸è¦å­¤æ³¨ä¸€æŽ·")
    md.append("5. **æŒç»­è·Ÿè¸ª**ï¼šæŠ•èµ„é€»è¾‘ä¼šéšçŽ¯å¢ƒå˜åŒ–ï¼Œéœ€å®šæœŸå¤ç›˜å’Œæ›´æ–°\n")

    md.append("\n---\n")
    md.append("\n*æœ¬æŠ¥å‘Šç”±AIåŸºäºŽåŽ†å²ç ”æŠ¥åˆ†æžç”Ÿæˆï¼Œä»…ä¾›å­¦ä¹ å‚è€ƒï¼Œä¸æž„æˆæŠ•èµ„å»ºè®®*\n")

    return '\n'.join(md)


def main():
    print("å¼€å§‹æå–æ ¸å¿ƒé€‰è‚¡é€»è¾‘...\n")

    extractor = InvestmentLogicExtractor("/home/user/automate-system/extracted_reports.json")
    refined, raw = extractor.generate_refined_logics()

    # ç”ŸæˆæŠ¥å‘Š
    markdown = generate_markdown_report(refined, raw)

    # ä¿å­˜
    output_file = "/home/user/automate-system/æ ¸å¿ƒé€‰è‚¡é€»è¾‘ç²¾ç‚¼ç‰ˆ.md"
    with open(output_file, 'w', encoding='utf-8') as f:
        f.write(markdown)

    print(f"âœ“ æŠ¥å‘Šå·²ç”Ÿæˆ: {output_file}")
    print(f"âœ“ æŠ¥å‘Šé•¿åº¦: {len(markdown):,} å­—ç¬¦\n")

    # æ‰“å°æ‘˜è¦
    print("="*80)
    print("æ ¸å¿ƒé€‰è‚¡é€»è¾‘æ‘˜è¦")
    print("="*80)

    total_logics = sum(len(logics) for logics in refined.values())
    print(f"\næ€»è®¡æç‚¼ {total_logics} æ¡æ ¸å¿ƒé€‰è‚¡é€»è¾‘\n")

    for category, logics in refined.items():
        print(f"\n{category}: {len(logics)} æ¡")
        for logic in logics[:3]:  # æ¯ä¸ªç±»åˆ«æ˜¾ç¤ºå‰3æ¡
            preview = logic[:60] + "..." if len(logic) > 60 else logic
            print(f"  - {preview}")

    print("\n" + "="*80)

if __name__ == "__main__":
    main()
